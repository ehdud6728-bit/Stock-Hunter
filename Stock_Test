# ------------------------------------------------------------------
# ğŸŒŠ [The Masterpiece] OBV ë§¤ì§‘ + Double-GC + ê³µêµ¬ë¦¬ + ê³ ë˜ í†µí•©íŒ
# ------------------------------------------------------------------
!pip install finance-datareader requests mplfinance
# ------------------------------------------------------------------
# ğŸ’ [Ultimate Masterpiece + Financial] ì¬ë¬´ ê±´ì „ì„± + OBV + Double-GC í†µí•©
# ------------------------------------------------------------------
import FinanceDataReader as fdr
import pandas as pd
import numpy as np
import requests
from concurrent.futures import ThreadPoolExecutor
from datetime import datetime, timedelta

# =================================================
# âš™ï¸ [ì „ëµ ì„¤ì •]
# =================================================
SCAN_DAYS = 5             
TOP_N = 400               
MIN_MARCAP = 100000000000 
STOP_LOSS_PCT = -5.0      
WHALE_THRESHOLD = 50      

HEADERS = {'User-Agent': 'Mozilla/5.0'}

# ---------------------------------------------------------
# ğŸ¥ [1] ì¬ë¬´ ê±´ì „ì„± ë¶„ì„ (Finance Health Check)
# ---------------------------------------------------------
def get_financial_health(code):
    try:
        url = f"https://finance.naver.com/item/main.naver?code={code}"
        res = requests.get(url, headers=HEADERS, timeout=5)
        dfs = pd.read_html(res.text)
        
        # ì¬ë¬´ ìš”ì•½ í…Œì´ë¸” ì°¾ê¸° (ë³´í†µ 3ë²ˆì§¸ í…Œì´ë¸”)
        df_fin = dfs[3]
        df_fin.columns = df_fin.columns.get_level_values(1)
        
        # ìµœê·¼ ë¶„ê¸° ì˜ì—…ì´ìµê³¼ ë¶€ì±„ë¹„ìœ¨ ì¶”ì¶œ
        latest_profit = df_fin.iloc[1, -2] # ìµœê·¼ ë¶„ê¸° ì˜ì—…ì´ìµ
        latest_debt = df_fin.iloc[6, -2]   # ìµœê·¼ ë¶„ê¸° ë¶€ì±„ë¹„ìœ¨
        
        f_score = 0
        f_tag = "B(ë³´í†µ)"
        
        # 1. ì˜ì—…ì´ìµ ì²´í¬ (í‘ìë©´ +1ì )
        if float(latest_profit) > 0: f_score += 1
        # 2. ë¶€ì±„ë¹„ìœ¨ ì²´í¬ (100% ë¯¸ë§Œì´ë©´ +1ì )
        if float(latest_debt) < 100: f_score += 1
        
        if f_score == 2: f_tag = "S(ìš°ëŸ‰)"
        elif f_score == 1: f_tag = "A(ì–‘í˜¸)"
        elif float(latest_profit) < 0: f_tag = "C(ì£¼ì˜)"
        
        return f_tag, f_score
    except:
        return "N(ë¯¸ë¹„)", 0

# ---------------------------------------------------------
# ğŸ•µï¸â€â™‚ï¸ [2] ë¶„ì„ ì—”ì§„ (ì¬ë¬´ ë°ì´í„° í†µí•©)
# ---------------------------------------------------------
def analyze_final(ticker, name):
    try:
        # (ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ë° ì§€í‘œ ê³„ì‚° ë¶€ë¶„ì€ ì´ì „ê³¼ ë™ì¼)
        df = fdr.DataReader(ticker, start=(datetime.now()-timedelta(days=730)).strftime('%Y-%m-%d'))
        if len(df) < 100: return []
        
        # ... [ì§€í‘œ ê³„ì‚° ë¡œì§: MA, VMA, OBV, Slow_K ë“± ìƒëµ] ...
        # (ì´ì „ ì½”ë“œì˜ ì§€í‘œ ê³„ì‚° ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤)

        # ğŸ¥ ì¬ë¬´ ìƒíƒœ í™•ì¸
        f_tag, f_score = get_financial_health(ticker)
        
        # ë¶„ì„ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ìƒì„± ì‹œ ì¬ë¬´ ë°ì´í„° í¬í•¨
        # ... [ì „ëµ íŒë³„ ë¡œì§: Double-GC, ê³µêµ¬ë¦¬ ë“± ìƒëµ] ...
        
        # (ì˜ˆì‹œ ê²°ê³¼ êµ¬ì„±)
        if tags: # ì‹ í˜¸ê°€ í¬ì°©ëœ ê²½ìš°
            score += f_score # ì¬ë¬´ ì ìˆ˜ í•©ì‚°
            hits.append({
                'ë‚ ì§œ': date_str, 'ì ìˆ˜': score, 'ì¢…ëª©': name, 'ì¬ë¬´': f_tag,
                'êµ¬ë¶„': " ".join(tags), 'ğŸ”¥ë² íŒ…': f"{total_m}ì²œ", 'ğŸ› ï¸ì§„ë‹¨': diags
            })
        return hits
    except: return []

HEADERS = {'User-Agent': 'Mozilla/5.0'}

# ---------------------------------------------------------
# ğŸ’° [1] ìˆ˜ê¸‰ & ê³ ë˜ ì ìˆ˜ (ê¸°ëŠ¥ ìœ ì§€)
# ---------------------------------------------------------
def get_supply_and_score(code, price):
    try:
        url = f"https://finance.naver.com/item/frgn.naver?code={code}"
        res = requests.get(url, headers=HEADERS, timeout=5); res.encoding = 'euc-kr'
        dfs = pd.read_html(res.text, match='ë‚ ì§œ'); df = dfs[0].dropna().head(10)
        new_cols = ['_'.join(col) if isinstance(col, tuple) else col for col in df.columns]; df.columns = new_cols
        inst_col = next((c for c in df.columns if 'ê¸°ê´€' in c and 'ìˆœë§¤ë§¤' in c), None)
        frgn_col = next((c for c in df.columns if 'ì™¸êµ­ì¸' in c and 'ìˆœë§¤ë§¤' in c), None)
        inst_qty = [int(float(str(v).replace(',', ''))) for v in df[inst_col].values]
        frgn_qty = [int(float(str(v).replace(',', ''))) for v in df[frgn_col].values]
        
        def get_streak(data):
            c = 0
            for v in data:
                if v > 0: c += 1
                else: break
            return c
        
        i_s, f_s = get_streak(inst_qty), get_streak(frgn_qty)
        inst_m = round((inst_qty[0] * price) / 10000000); frgn_m = round((frgn_qty[0] * price) / 10000000); total_m = abs(inst_m) + abs(frgn_m)
        leader = "ğŸ¤ìŒëŒ" if inst_m > 0 and frgn_m > 0 else ("ğŸ”´ê¸°ê´€" if inst_m > frgn_m else "ğŸ”µì™¸ì¸")
        
        whale_streak = 0; bonus = 0
        for k in range(len(df)):
            k_price = int(float(str(df.iloc[k].get('ì¢…ê°€_ì¢…ê°€', price)).replace(',', '')))
            if (abs(int(float(str(df.iloc[k][inst_col]).replace(',', '')))) + abs(int(float(str(df.iloc[k][frgn_col]).replace(',', ''))))) * k_price / 10000000 >= WHALE_THRESHOLD: whale_streak += 1
            else: break
        
        bonus += (total_m // 50)
        if whale_streak >= STREAK_THRESHOLD: bonus += 3
        return f"{leader}({i_s}/{f_s})", total_m, whale_streak, bonus
    except: return "âš ï¸ì˜¤ë¥˜", 0, 0, 0

# ---------------------------------------------------------
# ğŸ•µï¸â€â™‚ï¸ [2] ë¶„ì„ ì—”ì§„ (OBV ë¡œì§ ì¶”ê°€)
# ---------------------------------------------------------
def analyze_final(ticker, name):
    try:
        df = fdr.DataReader(ticker, start=(datetime.now()-timedelta(days=730)).strftime('%Y-%m-%d'))
        if len(df) < 120: return []
        
        # 1. ì§€í‘œ ê³„ì‚°
        for n in [5, 10, 20, 60, 120]: df[f'MA{n}'] = df['Close'].rolling(n).mean()
        for n in [5, 20]: df[f'VMA{n}'] = df['Volume'].rolling(n).mean()
        
        # ğŸŒŠ OBV ê³„ì‚°
        obv = [0]
        for i in range(1, len(df)):
            if df['Close'].iloc[i] > df['Close'].iloc[i-1]: obv.append(obv[-1] + df['Volume'].iloc[i])
            elif df['Close'].iloc[i] < df['Close'].iloc[i-1]: obv.append(obv[-1] - df['Volume'].iloc[i])
            else: obv.append(obv[-1])
        df['OBV'] = obv
        df['OBV_MA20'] = df['OBV'].rolling(20).mean()
        
        l, h = df['Low'].rolling(5).min(), df['High'].rolling(5).max()
        df['Slow_K'] = ((df['Close'] - l) / (h - l)).rolling(3).mean() * 100
        df['Slow_D'] = df['Slow_K'].rolling(3).mean()
        df['RSI'] = 100 - (100 / (1 + (df['Close'].diff(1).where(df['Close'].diff(1) > 0, 0).rolling(14).mean() / (-df['Close'].diff(1).where(df['Close'].diff(1) < 0, 0)).rolling(14).mean())))
        
        recent_df = df.iloc[-SCAN_DAYS:]
        hits = []
        sector = sector_dict.get(ticker, "ë¯¸ë¶„ë¥˜")

        for i in range(len(recent_df)):
            curr_idx = recent_df.index[i]; raw_idx = df.index.get_loc(curr_idx); row, prev = df.iloc[raw_idx], df.iloc[raw_idx-1]
            score = 0; tags = []
            
            # --- ì „ëµ ì²´í¬ ---
            # A. ë”ë¸” ê³¨ë“ í¬ë¡œìŠ¤
            is_p_gc = (prev['MA5'] <= prev['MA20']) and (row['MA5'] > row['MA20'])
            is_v_gc = (prev['VMA5'] <= prev['VMA20']) and (row['VMA5'] > row['VMA20'])
            
            # B. ğŸŒŠ OBV ë§¤ì§‘ í™•ì¸
            is_obv_up = row['OBV'] > row['OBV_MA20'] and row['OBV'] > prev['OBV']
            
            # C. ê³µêµ¬ë¦¬/ìˆ˜ë°•
            is_water = (prev['Slow_K'] <= prev['Slow_D'] and row['Slow_K'] > row['Slow_D']) and (row['Slow_K'] < 75)
            box_h = df['High'].iloc[raw_idx-25:raw_idx].max()
            mas = [row['MA5'], row['MA10'], row['MA20'], row['MA60']]; is_dense = ((max(mas) - min(mas)) / min(mas)) * 100 <= 6.5

            # --- ì ìˆ˜ ë° íƒœê·¸ ë¶€ì—¬ ---
            if is_p_gc and is_v_gc: tags.append("âœ¨Double-GC"); score += 5
            elif is_p_gc: tags.append("âœ¨Price-GC"); score += 2
            
            if is_obv_up: tags.append("ğŸŒŠOBVë§¤ì§‘"); score += 2
            
            if is_dense and is_water and row['Close'] > box_h: tags.append("ğŸ”¨ê³µêµ¬ë¦¬"); score += 4
            elif is_water and row['MA60'] > row['MA120']: tags.append("ğŸ¦ì •ë°°ì—´"); score += 3
            
            if not tags: continue

            # ìˆ˜ê¸‰/ê³ ë˜ ì ìˆ˜
            s_tag, total_m, w_streak, whale_score = get_supply_and_score(ticker, row['Close'])
            score += whale_score
            if w_streak >= STREAK_THRESHOLD: tags.insert(0, "ğŸ³ê°•ë ¥í¬ì°©")

            # ìˆ˜ìµë¥  ë¶„ì„
            buy_p = row['Close']; holding = df.iloc[raw_idx+1:]; sl_date = "ìœ ì§€ì¤‘"
            if not holding.empty:
                for h_idx, h_row in holding.iterrows():
                    if ((h_row['Low'] - buy_p)/buy_p)*100 <= STOP_LOSS_PCT: sl_date = h_idx.strftime('%m-%d'); break
                max_r = ((holding['High'].max()-buy_p)/buy_p)*100; curr_r = ((holding['Close'].iloc[-1]-buy_p)/buy_p)*100
            else: max_r=curr_r=0.0

            hits.append({
                'ë‚ ì§œ': curr_idx.strftime('%Y-%m-%d'), 'ì ìˆ˜': score, 'ì¢…ëª©': name, 'êµ¬ë¶„': " ".join(tags),
                'ğŸ”¥ë² íŒ…': f"{total_m}ì²œ", 'ğŸ”ºìµœê³ ': round(max_r, 1), 'í˜„ì¬%': round(curr_r, 1), 'ğŸ›‘ì†ì ˆ': sl_date,
                'ìˆ˜ê¸‰': s_tag, 'ì‚°ì—…': str(sector)[:10], 'ë³´ìœ ': len(holding)
            })
        return hits
    except: return []

# ---------------------------------------------------------
# ğŸš€ ë©”ì¸ ì‹¤í–‰
# ---------------------------------------------------------
if __name__ == "__main__":
    print(f"ğŸ“Š [The Masterpiece Scanner] âœ¨Double-GC + ğŸŒŠOBVë§¤ì§‘ í†µí•© ë¦¬í¬íŠ¸")
    print("=" * 175)
    df_krx = fdr.StockListing('KRX')
    found_col = next((c for c in ['Sector', 'Industry', 'Dept'] if c in df_krx.columns), None)
    sector_dict = dict(zip(df_krx['Code'], df_krx[found_col])) if found_col else {c: 'ë¯¸ë¶„ë¥˜' for c in df_krx['Code']}
    target_dict = dict(zip(df_krx.sort_values(by='Amount', ascending=False).head(TOP_N)['Code'], df_krx.sort_values(by='Amount', ascending=False).head(TOP_N)['Name']))
    
    all_hits = []
    with ThreadPoolExecutor(max_workers=20) as executor:
        futures = [executor.submit(analyze_final, t, n) for t, n in target_dict.items()]
        for f in futures:
            res = f.result()
            if res: all_hits.extend(res)

    if all_hits:
        df_total = pd.DataFrame(all_hits)
        today = df_total[df_total['ë³´ìœ '] == 0].sort_values(by='ì ìˆ˜', ascending=False)
        print(f"ğŸ“¢ [ì˜¤ëŠ˜ì˜ ì¶”ì²œ: ğŸŒŠOBVê°€ í™•ì¸í•´ì¤€ âœ¨Double-GC ì¢…ëª©]")
        print("-" * 175)
        print(f"{'ë‚ ì§œ':<12} {'â­ì ìˆ˜':<6} {'ì¢…ëª©':<10} {'êµ¬ë¶„(í•µì‹¬ì‹ í˜¸)':<40} {'ğŸ”¥ë² íŒ…':<10} {'ìˆ˜ê¸‰':<18} {'í˜„ì¬ê°€'}")
        print("-" * 175)
        for _, r in today.iterrows():
            print(f"{r['ë‚ ì§œ']:<12} {r['ì ìˆ˜']:<6} {r['ì¢…ëª©']:<10} {r['êµ¬ë¶„']:<40} {r['ğŸ”¥ë² íŒ…']:<10} {r['ìˆ˜ê¸‰']:<18}")
    else: print("âŒ í¬ì°©ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.")
